# the upstream component nginx needs to connect to
upstream app {
    server unix:///run/uwsgi/app.sock;
}

# configuration of the server
server {
    {% if pillar.elife.env == 'dev' %}
    listen      80;
    {% else %}
    # ssl for all non-dev environments
    listen      443;
    {% endif %}
    
    {% if pillar.elife.env == 'dev' %}
    server_name     localhost
    {% else %}
    server_name     {{ salt['elife.cfg']('cfn.outputs.DomainName') }}
    {% endif %}

    charset     utf-8;

    access_log /var/log/nginx/app.access.log;
    error_log /var/log/nginx/app.error.log;

    {% if pillar.elife.env != 'dev' %}
    # ssl for all non-dev environments
    ssl on;
    ssl_certificate     /etc/letsencrypt/live/{{ salt['elife.cfg']('cfn.outputs.DomainName') }}/cert.pem;
    ssl_certificate_key /etc/letsencrypt/live/{{ salt['elife.cfg']('cfn.outputs.DomainName') }}/privkey.pem;

    ssl_stapling on;
    ssl_stapling_verify on;
    ssl_trusted_certificate /etc/letsencrypt/live/{{ salt['elife.cfg']('cfn.outputs.DomainName') }}/fullchain.pem;
    {% endif %}

    # max upload size
    client_max_body_size 5M;

    # used for Swagger and admin
    location /static {
        alias /srv/app/dashboard/static;
    }

    # all non-media requests
    location / {
        auth_basic "restricted";
        auth_basic_user_file .production-htpasswd;

        uwsgi_pass app;
        # drop connection after this many seconds
        # WARNING: this value *must* be higher than uwsgi's 'harakiri' value
        # (10s) in /srv/lax/uwsgi.ini
        uwsgi_read_timeout 15s;
        include /etc/uwsgi/params;
    }
}
